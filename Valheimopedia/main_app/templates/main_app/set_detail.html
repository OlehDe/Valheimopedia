{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% if set %}{{ set.setName }}{% else %}Помилка{% endif %} - Valheimopedia</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>

<header>
  <h1>Valheimopedia</h1>
  <div class="auth-buttons">
    {% if user.is_authenticated %}
      <a href="/account">Акаунт</a>
    {% else %}
      <a href="/login">Увійти</a>
      <a href="/register">Зареєструватися</a>
    {% endif %}
  </div>
</header>

<nav>
  <a href="/">Головна</a>
  <a href="/all_news/">Усі новини</a>
  <a href="{% url 'main_app:all_items' %}">Усі предмети</a>
</nav>

<main>
    <a href="{% url 'main_app:all_items' %}" class="back-link">← Повернутися до списку предметів</a>

    {% if error %}
        <div class="error-message">
          <p>{{ error }}</p>
        </div>

    {% elif set %}
        <div class="set-detail-container">
            <div class="set-header">
                <div class="set-image-wrapper">
                    {% if set.set_image_url %}
                        <img src="{{ set.set_image_url }}" alt="{{ set.setName }}">
                    {% else %}
                        <span style="color: var(--text-light);">Немає фото</span>
                    {% endif %}
                </div>
                <div class="set-info">
                    <h1>{{ set.setName }}</h1>
                    <p>Категорія: {{ set.setCategory }}</p>
                </div>
            </div>

            <div class="set-stats-section">
                <h2>Характеристики Комплекту</h2>

                <div class="general-stats">
                    {% if set.Weight %}<p><strong>Вага:</strong> {{ set.Weight }}</p>{% endif %}
                    {% if set.MovementSpeed %}
                        <p><strong>Швидкість руху:</strong> {{ set.MovementSpeed }}</p>
                    {% endif %}
                    {% if set.Effects %}<p><strong>Ефекти:</strong> {{ set.Effects|linebreaksbr }}</p>{% endif %}
                </div>

                <div class="level-tabs" id="level-tabs-container">
                    <!-- Тут будуть кнопки рівнів -->
                </div>

                <div class="stats-content-box" id="stats-content">
                    <!-- Тут будуть стати -->
                </div>
            </div>

            <div class="set-items-list">
                <h2>Предмети в комплекті:</h2>
                {% for item in set.items_with_data %}
                <div class="item-in-set">
                    <div class="item-in-set-image">
                        {% if item.image_url %}
                            <img src="{{ item.image_url }}" alt="{{ item.name }}">
                        {% endif %}
                    </div>
                    <div class="item-in-set-info">
                        <h3>
                           <a href="{% url 'main_app:item_detail' item.assetId %}">
                               {{ item.name }}
                           </a>
                        </h3>
                        <p>Тип: {{ item.type }}</p>
                        <p>{{ item.description }}</p>
                    </div>
                </div>
                {% empty %}
                    <p>Цей комплект не містить предметів.</p>
                {% endfor %}
            </div>
        </div>

    {% else %}
        <div class="error-message">
          <p>Комплект не знайдено.</p>
        </div>
    {% endif %}
</main>

{{ set|json_script:"set-data" }}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const setDataElement = document.getElementById('set-data');
        if (!setDataElement) return;

        const setData = JSON.parse(setDataElement.textContent);
        const tabsContainer = document.getElementById('level-tabs-container');
        const contentContainer = document.getElementById('stats-content');

        if (!setData || !tabsContainer || !contentContainer) {
            console.error("Помилка: Необхідні елементи DOM не знайдено.");
            return;
        }

        const keyNames = {
            "Armor set": "Броня комплекту",
            "Workbench level": "Рівень верстака",
            "Forge level": "Рівень кузні",
            "Black forge level": "Рівень чорної кузні",
            "Galdr table level": "Рівень Стола Галдра",
            "Forge level crafting": "Рівень кузні (крафт)",
            "Forge level repairing": "Рівень кузні (ремонт)",
            "Forge level1": "Рівень кузні (шолом)",
            "Forge level2": "Рівень кузні (тіло/ноги)",
            "Durability": "Міцність",
            "Cape Durability": "Міцність плаща"
        };

        function renderStats(levelKey) {
            const stats = setData[levelKey];
            if (!stats) {
                contentContainer.innerHTML = '<p>Немає даних для цього рівня.</p>';
                return;
            }

            let html = '';
            for (const key in stats) {
                const displayName = keyNames[key] || key;
                html += `<p><strong>${displayName}:</strong> <span>${stats[key]}</span></p>`;
            }
            contentContainer.innerHTML = html;
        }

        let firstLevelKey = null;
        const levelKeys = Object.keys(setData)
            .filter(key => key.startsWith('level'))
            .sort((a, b) => {
                const numA = parseInt(a.replace('level', ''));
                const numB = parseInt(b.replace('level', ''));
                return numA - numB;
            });

        if(levelKeys.length === 0) {
             tabsContainer.style.display = 'none';
             contentContainer.style.display = 'none';
             return;
        }

        levelKeys.forEach((key, index) => {
            const levelNum = key.replace('level', '');
            if(index === 0) firstLevelKey = key;

            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'level-tab-button';
            button.textContent = `Якість ${levelNum}`;
            button.dataset.levelKey = key;

            if(index === 0) button.classList.add('active');

            button.addEventListener('click', () => {
                tabsContainer.querySelectorAll('.level-tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                renderStats(button.dataset.levelKey);
            });

            tabsContainer.appendChild(button);
        });

        if (firstLevelKey) renderStats(firstLevelKey);
    });
</script>

</body>
</html>